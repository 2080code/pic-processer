{"version":3,"file":"pic-processer.min.js","sources":["../src/pic-processer.ts"],"sourcesContent":["/**\r\n * picture processer\r\n * 用来对图片做压缩，把 File 对象转为 dataURL，又或者把 dataURL 转为 File 对象。\r\n * @author Warren\r\n */\r\n\r\n/**\r\n * File 转为dataURL\r\n * @param {File,Blob} file\r\n * @returns {Promise}\r\n */\r\nfunction getDataURL(file:File|Blob):Promise<string> {\r\n    return new Promise((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        // reader.addEventListener('loadstart', () => {\r\n        // })\r\n        reader.addEventListener('load', () => {\r\n            resolve(reader?.result as string)\r\n        }, false);\r\n        reader.addEventListener('loadend', () => {\r\n            console.log('loadend',reader)\r\n            resolve(reader?.result as string)\r\n        })\r\n        reader.addEventListener('error', () => {\r\n            reject(new Error('getDataURL error!'))\r\n        })\r\n        reader.addEventListener('abort', () => {\r\n            reject(new Error('getDataURL abort!'))\r\n        })\r\n        if (file && [Blob,File].some(type=>file instanceof type)) {\r\n            reader.readAsDataURL(file)\r\n        } else {\r\n            reject(new Error('Unspecified file!'))\r\n        }\r\n    })\r\n}\r\n\r\n/**\r\n * 压缩\r\n * @param {File,Blob} file\r\n * @param {Number} ratio 压缩比\r\n * @param {Number} maxWidth 尺寸限制，单位像素\r\n * @param {string} mime 输出图片类型，默认`image/jpeg`\r\n * @returns {Promise}\r\n */\r\nfunction compress(file:File|Blob, ratio:number = 0.5, maxWidth:number = null,mime:string='image/jpeg'):Promise<string> {\r\n    // console.log(ratio, maxWidth)\r\n    // 通过构造函数来创建的 img 实例，在赋予 src 值后就会立刻下载图片，相比 createElement() 创建 <img> 省去了 append()，也就避免了文档冗余和污染\r\n    return new Promise((resolve, reject) => {\r\n        let dataURL = '';\r\n        const img = new Image();\r\n\r\n        // 尺寸限制必须大于1，否则canvas是渲染不出内容的\r\n        if(maxWidth && maxWidth<2) {\r\n            reject(new Error('maxWidth must be greater than 1!'))\r\n        }\r\n\r\n        img.addEventListener('loadstart', () => {\r\n        })\r\n        img.addEventListener('load', () => {\r\n            const canvas = document.createElement('canvas'); // 创建canvas元素\r\n            let scaleRatio = 1\r\n            if (maxWidth && img.width > maxWidth) {\r\n                scaleRatio = maxWidth / img.width\r\n            }\r\n            const width=img.width * scaleRatio\r\n            const height=img.height * scaleRatio\r\n            // 确保canvas的尺寸和图片一样\r\n            canvas.width = width;\r\n            canvas.height = height;\r\n            canvas.getContext('2d').drawImage(img, 0, 0, width, height); // 将图片绘制到canvas中\r\n            dataURL = canvas.toDataURL(mime, +ratio); // 转换图片为dataURL\r\n            resolve(dataURL)\r\n        }, false);\r\n        img.addEventListener('loadend', () => {\r\n            resolve(dataURL)\r\n        })\r\n        img.addEventListener('error', () => {\r\n            reject(new Error('compress error!'))\r\n        })\r\n        img.addEventListener('abort', () => {\r\n            reject(new Error('compress abort!'))\r\n        })\r\n\r\n        if (file && [Blob,File].some(type=>file instanceof type)) {\r\n            this.getDataURL(file).then(res => {\r\n                img.src = res\r\n            }).catch(error => {\r\n                reject(error)\r\n            })\r\n        } else {\r\n            reject(new Error('no file!'))\r\n        }\r\n\r\n        \r\n    })\r\n}\r\n\r\n/**\r\n * dataURL 转为 File\r\n * @param {String} fileName 文件名\r\n * @param {String} dataURL\r\n * @returns {File}\r\n */\r\nfunction dataURLtoFile(fileName:string, dataURL:string):File {\r\n  const arr = dataURL.split(',');\r\n  const mime = arr[0].match(/:(.*?);/)[1];\r\n  const bstr = window.atob(arr[1]);\r\n  let n = bstr.length;\r\n  const u8arr = new Uint8Array(n);\r\n  while (n--) {\r\n    u8arr[n] = bstr.charCodeAt(n);\r\n  }\r\n  return new File([u8arr], fileName, { type: mime });\r\n}\r\n\r\nexport default class PicProcesser {\r\n  constructor() {\r\n  }\r\n  compress=compress\r\n  getDataURL=getDataURL\r\n  dataURLtoFile=dataURLtoFile\r\n}\r\n"],"names":["getDataURL","file","Promise","resolve","reject","reader","FileReader","addEventListener","result","console","log","Error","Blob","File","some","type","readAsDataURL","compress","ratio","maxWidth","mime","dataURL","img","Image","canvas","document","createElement","scaleRatio","width","height","getContext","drawImage","toDataURL","this","then","res","src","catch","error","dataURLtoFile","fileName","arr","split","match","bstr","window","atob","n","length","u8arr","Uint8Array","charCodeAt","constructor"],"mappings":"4OAWA,SAASA,EAAWC,GAChB,OAAO,IAAIC,QAAQ,CAACC,EAASC,KACzB,MAAMC,EAAS,IAAIC,WAGnBD,EAAOE,iBAAiB,OAAQ,KAC5BJ,EAAQE,eAAAA,EAAQG,UACjB,GACHH,EAAOE,iBAAiB,UAAW,KAC/BE,QAAQC,IAAI,UAAUL,GACtBF,EAAQE,eAAAA,EAAQG,UAEpBH,EAAOE,iBAAiB,QAAS,KAC7BH,EAAO,IAAIO,MAAM,wBAErBN,EAAOE,iBAAiB,QAAS,KAC7BH,EAAO,IAAIO,MAAM,wBAEjBV,GAAQ,CAACW,KAAKC,MAAMC,KAAKC,GAAMd,aAAgBc,GAC/CV,EAAOW,cAAcf,GAErBG,EAAO,IAAIO,MAAM,uBAG7B,CAUA,SAASM,EAAShB,EAAgBiB,EAAe,GAAKC,EAAkB,KAAKC,EAAY,cAGrF,OAAO,IAAIlB,QAAQ,CAACC,EAASC,KACzB,IAAIiB,EAAU,GACd,MAAMC,EAAM,IAAIC,MAGbJ,GAAYA,EAAS,GACpBf,EAAO,IAAIO,MAAM,qCAGrBW,EAAIf,iBAAiB,YAAa,QAElCe,EAAIf,iBAAiB,OAAQ,KACzB,MAAMiB,EAASC,SAASC,cAAc,UACtC,IAAIC,EAAa,EACbR,GAAYG,EAAIM,MAAQT,IACxBQ,EAAaR,EAAWG,EAAIM,OAEhC,MAAMA,EAAMN,EAAIM,MAAQD,EAClBE,EAAOP,EAAIO,OAASF,EAE1BH,EAAOI,MAAQA,EACfJ,EAAOK,OAASA,EAChBL,EAAOM,WAAW,MAAMC,UAAUT,EAAK,EAAG,EAAGM,EAAOC,GACpDR,EAAUG,EAAOQ,UAAUZ,GAAOF,GAClCf,EAAQkB,KACT,GACHC,EAAIf,iBAAiB,UAAW,KAC5BJ,EAAQkB,KAEZC,EAAIf,iBAAiB,QAAS,KAC1BH,EAAO,IAAIO,MAAM,sBAErBW,EAAIf,iBAAiB,QAAS,KAC1BH,EAAO,IAAIO,MAAM,sBAGjBV,GAAQ,CAACW,KAAKC,MAAMC,KAAKC,GAAMd,aAAgBc,GAC/CkB,KAAKjC,WAAWC,GAAMiC,KAAKC,IACvBb,EAAIc,IAAMD,IACXE,MAAMC,IACLlC,EAAOkC,KAGXlC,EAAO,IAAIO,MAAM,cAK7B,CAQA,SAAS4B,EAAcC,EAAiBnB,GACtC,MAAMoB,EAAMpB,EAAQqB,MAAM,KACpBtB,EAAOqB,EAAI,GAAGE,MAAM,WAAW,GAC/BC,EAAOC,OAAOC,KAAKL,EAAI,IAC7B,IAAIM,EAAIH,EAAKI,OACb,MAAMC,EAAQ,IAAIC,WAAWH,GAC7B,KAAOA,KACLE,EAAMF,GAAKH,EAAKO,WAAWJ,GAE7B,OAAO,IAAIlC,KAAK,CAACoC,GAAQT,EAAU,CAAEzB,KAAMK,GAC7C,QAEc,MACZ,WAAAgC,GAEAnB,KAAAhB,SAASA,EACTgB,KAAAjC,WAAWA,EACXiC,KAAAM,cAAcA,CAHd"}